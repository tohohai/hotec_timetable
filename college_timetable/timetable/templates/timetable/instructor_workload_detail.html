<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Chi tiết khối lượng {{ instructor.name }} - {{ academic_year.code }}</title>
  <style>
    body { font-family: Arial, sans-serif; font-size: 14px; }
    h1, h2, h3 { margin-bottom: 0.5rem; }
    table { border-collapse: collapse; width: 100%; margin-top: 0.5rem; }
    th, td {
      border: 1px solid #999;
      padding: 4px 6px;
      vertical-align: top;
      font-size: 13px;
    }
    th { background: #eee; }
    .overload { color: red; font-weight: bold; }
    .underload { color: green; }
    .nowrap { white-space: nowrap; }
    small { color: #555; }
    a { text-decoration: none; }
  </style>
</head>
<body>
    {% load math_filters %}
  <p>
    <a href="{% url 'timetable:instructor_workload' %}?academic_year={{ academic_year.id }}">&larr; Quay lại bảng tổng hợp</a>
  </p>

  <h1>Khối lượng giảng viên - {{ instructor.name }} ({{ instructor.code }})</h1>
  <h2>Năm học: {{ academic_year.code }}</h2>

  <h3>Tóm tắt</h3>
  <table>
    <tr>
      <th>ĐM GD gốc</th>
      <th>Giảm GD</th>
      <th>ĐM GD còn lại</th>
      <th>Giờ dạy thực tế</th>
      <th>Dư / thiếu GD</th>
    </tr>
    <tr>
      <td>{{ row.base_teaching_quota|floatformat:1 }}</td>
      <td>{{ row.teaching_reduced_hours|floatformat:1 }}</td>
      <td>{{ row.teaching_quota_adj|floatformat:1 }}</td>
      <td>{{ row.teaching_hours|floatformat:1 }}</td>
      <td>
        {% if row.teaching_overload > 0 %}
          <span class="overload">+{{ row.teaching_overload|floatformat:1 }}</span>
        {% else %}
          <span class="underload">{{ row.teaching_overload|floatformat:1 }}</span>
        {% endif %}
      </td>
    </tr>
    <tr>
      <th>ĐM HC gốc</th>
      <th>Giảm HC</th>
      <th>ĐM HC còn lại</th>
      <th>Tổng giờ HC</th>
      <th>Dư / thiếu HC</th>
    </tr>
    <tr>
      <td>{{ row.base_admin_quota|floatformat:1 }}</td>
      <td>{{ row.admin_reduced_hours|floatformat:1 }}</td>
      <td>{{ row.admin_quota_adj|floatformat:1 }}</td>
      <td>{{ row.admin_hours_total|floatformat:1 }}</td>
      <td>
        {% if row.admin_overload > 0 %}
          <span class="overload">+{{ row.admin_overload|floatformat:1 }}</span>
        {% else %}
          <span class="underload">{{ row.admin_overload|floatformat:1 }}</span>
        {% endif %}
      </td>
    </tr>
  </table>

  <h3>Chi tiết nhiệm vụ giảm định mức</h3>
  {% if row.duty_breakdown %}
    <table>
      <thead>
        <tr>
          <th>Nhiệm vụ</th>
          <th>Số tháng</th>
          <th>% giảm GD</th>
          <th>Giờ giảm GD</th>
          <th>% giảm HC</th>
          <th>Giờ giảm HC</th>
          <th>Ghi chú</th>
        </tr>
      </thead>
      <tbody>
        {% for b in row.duty_breakdown %}
          <tr>
            <td>{{ b.obj.reduction_type.name }}</td>
            <td>{{ b.months }}</td>
            <td>{{ b.teaching_percent }}</td>
            <td>{{ b.teaching_hours|floatformat:1 }}</td>
            <td>{{ b.admin_percent }}</td>
            <td>{{ b.admin_hours|floatformat:1 }}</td>
            <td>{{ b.obj.note }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Không có nhiệm vụ giảm định mức trong năm học này.</p>
  {% endif %}

  <h3>Chi tiết Nghiên cứu khoa học</h3>
  {% if research_members %}
    <table>
      <thead>
        <tr>
          <th>Đề tài</th>
          <th>Loại</th>
          <th>Vai trò</th>
          <th>Số lượng</th>
          <th>Giờ quy đổi của đề tài</th>
          <th>Tỷ lệ hưởng</th>
          <th>Giờ tính cho GV</th>
        </tr>
      </thead>
      <tbody>
        {% for m in research_members %}
          <tr>
            <td>{{ m.project.topic_name }}</td>
            <td>
              {% if m.project.category %}
                {{ m.project.category.name }}
                <small>({{ m.project.category.unit_label }})</small>
              {% endif %}
            </td>
            <td>
              {% if m.role == "CN" %}Chủ nhiệm{% else %}Cộng sự{% endif %}
            </td>
            <td>{{ m.project.quantity }}</td>
            <td>{{ m.project.hours|floatformat:1 }}</td>
            <td>
              {% if m.share_ratio %}
                {{ m.share_ratio|floatformat:2 }}
              {% else %}
                <!-- share sẽ được tính tự động khi tổng hợp -->
                Tự chia (quy tắc 6:4/4:3:3...)
              {% endif %}
            </td>
            <td>
              {# giờ dự kiến cho GV, chỉ tính nếu có share_ratio #}
              {% if m.share_ratio %}
                {{ m.project.hours|floatformat:1 }} × {{ m.share_ratio|floatformat:2 }} ≈
                {{ m.project.hours|mul:m.share_ratio|floatformat:1 }}
              {% else %}
                (xem cột NCKH tổng ở phần tóm tắt)
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p>Giảng viên chưa tham gia đề tài NCKH nào trong năm học này.</p>
  {% endif %}

  <h3>Tổng hợp giờ Hành chính chi tiết</h3>
  <ul>
    <li>NCKH: {{ row.rp_hours|floatformat:1 }} giờ</li>
    <li>TTDN: {{ row.ei_hours|floatformat:1 }} giờ</li>
    <li>Bồi dưỡng: {{ row.pd_hours|floatformat:1 }} giờ</li>
    <li>Giờ dạy quy đổi sang HC: {{ row.teaching_to_admin_hours|floatformat:1 }} giờ</li>
    <li><strong>Tổng HC: {{ row.admin_hours_total|floatformat:1 }} giờ</strong></li>
  </ul>
</body>
</html>
