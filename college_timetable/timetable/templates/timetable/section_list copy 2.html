{% extends "timetable/base.html" %}

{% block title %}Danh sách Lớp học phần{% endblock %}

{% block content %}
<div class="container mt-3">
  <h1 class="mb-3">Danh sách Lớp học phần</h1>

  <p class="text-muted">
    Đây là danh sách LHP (CourseSection) theo Học kỳ / Khoa.
    Từ đây có thể:
    <br>
    – Xem chi tiết TKB của từng LHP.<br>
    – Vào màn hình xếp bán tự động / chỉnh tay (nếu đã cấu hình).
  </p>

  <div class="mb-2">
    {% if semester %}
      <span class="badge text-bg-info">
        Học kỳ: {{ semester.code }} ({{ semester.academic_year.code }})
      </span>
    {% endif %}
    {% if department %}
      <span class="badge text-bg-secondary ms-1">
        Khoa phụ trách môn: {{ department.name }}
      </span>
    {% endif %}
    {% if not semester and not department %}
      <span class="text-muted">
        (Không lọc – đang hiển thị tất cả Lớp học phần)
      </span>
    {% endif %}
  </div>

  {% if sections %}
    <table class="table table-sm table-bordered table-striped align-middle">
      <thead class="table-light">
        <tr>
          <th class="text-center">#</th>
          <th>Mã LHP</th>
          <th>Môn học</th>
          <th>Lớp sinh viên</th>
          <th>Giảng viên</th>
          <th class="text-center">Tổng tiết</th>
          <th>Ghi chú</th>
          <th class="text-center">Thao tác</th>
        </tr>
      </thead>
      <tbody>
        {% for s in sections %}
          <tr>
            <td class="text-center">{{ forloop.counter }}</td>
            <td>
              <strong>{{ s.code }}</strong><br>
              <small class="text-muted">
                HK: {{ s.semester.code }} ({{ s.semester.academic_year.code }})
              </small>
            </td>
            <td>
              {{ s.subject.code }} – {{ s.subject.name }}<br>
              <small class="text-muted">
                Loại: {{ s.subject.get_subject_type_display }}
              </small>
            </td>
            <td>
              {% for c in s.classes.all %}
                {{ c.code }}{% if not forloop.last %}, {% endif %}
              {% empty %}
                <em>Chưa gán lớp SV</em>
              {% endfor %}
            </td>
            <td>
              {% if s.instructor %}
                {{ s.instructor.name }}
              {% else %}
                <span class="text-danger">Chưa phân GV</span>
              {% endif %}
            </td>
            <td class="text-center">
              {% if s.planned_periods %}
                {{ s.planned_periods|floatformat:-1 }}
              {% else %}
                {{ s.subject.total_periods|floatformat:-1 }}
              {% endif %}
            </td>
            <td>{{ s.note }}</td>
            <td class="text-center">
              <a href="{% url 'timetable:section_schedule' s.id %}"
                 class="btn btn-sm btn-outline-primary mb-1">
                Xem / xếp TKB
              </a>
              {# Nếu sau này có view in Excel: #}
              {# <a href="{% url 'timetable:section_export_excel' s.id %}" class="btn btn-sm btn-outline-success">
                   Xuất Excel
                 </a> #}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p class="text-muted">Chưa có Lớp học phần nào phù hợp với bộ lọc.</p>
  {% endif %}

  <a href="{% url 'timetable:semester_overview' %}" class="btn btn-secondary mt-2">
    ← Quay lại chọn Học kỳ
  </a>
</div>
{% endblock %}
