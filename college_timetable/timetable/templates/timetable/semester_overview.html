{% extends "timetable/base.html" %}

{% block title %}Chọn Học kỳ & Xếp TKB{% endblock %}

{% block content %}
<div class="container mt-3">

  <h1 class="mb-3">Chọn Học kỳ & Xếp Thời khóa biểu</h1>

  <p class="text-muted">
    Chọn Năm học, Học kỳ (và Khoa, nếu có) rồi:
    <br>
    – <strong>“Xem lớp học phần”</strong> để xem danh sách LHP và xếp TKB bán tự động / chỉnh tay.<br>
    – <strong>“Xếp TKB tự động”</strong> để chạy engine auto cho các LHP của Học kỳ/Khoa đó.
  </p>

  <form method="post" class="card p-3 mb-3">
    {% csrf_token %}
    {{ form.as_p }}

    <div class="mt-2">
      <button type="submit" name="view_sections" class="btn btn-secondary">
        Xem lớp học phần
      </button>

      <button type="submit" name="auto_schedule" class="btn btn-primary">
        Xếp TKB tự động
      </button>
      
    </div>
  </form>

  {% if selected_semester %}
    <div class="alert alert-info">
      <strong>Đã chọn Học kỳ:</strong>
      {{ selected_semester.code }} ({{ selected_semester.academic_year.code }})
      {% if selected_department %}
        &nbsp;|&nbsp; <strong>Khoa:</strong> {{ selected_department.name }}
      {% endif %}
    </div>
  {% endif %}

  {% if auto_result %}
    <h3>Kết quả xếp TKB tự động</h3>

    <p>
      <strong>Số LHP xếp được:</strong> {{ auto_result.ok|length }}<br>
      <strong>Số LHP không xếp được:</strong> {{ auto_result.fail|length }}
    </p>

    {% if auto_result.ok %}
      <h5>Danh sách LHP đã xếp:</h5>
      <ul>
        {% for sec in auto_result.ok %}
          <li>
            {{ sec.code }} – {{ sec.subject.name }}
            {% if sec.instructor %}
              (GV: {{ sec.instructor.name }})
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {% if auto_result.fail %}
      <h5>LHP không xếp được:</h5>
      <ul>
        {% for sec, reason in auto_result.fail %}
          <li>
            <strong>{{ sec.code }}</strong> – {{ sec.subject.name }}:
            <span class="text-danger">{{ reason }}</span>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
  {% endif %}

</div>
{% endblock %}
